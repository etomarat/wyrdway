# TUNING — спецификация баланса (препрод)

## 1. Назначение
Документ описывает, **как должна работать система TUNING** (набор «ручек» баланса) в игре **Wyrdway**.

Цели:
- убрать «магические числа» из логики;
- обеспечить быстрый итеративный баланс без переписывания систем;
- поддержать расширяемость контентом (POI/враги/лут/апгрейды), чтобы контент настраивался данными;
- обеспечить воспроизводимость тестов и предсказуемость изменений.

## 2. Определения
- **TUNING** — единый набор числовых параметров, влияющих на ощущение управления, тайминги, урон, награды, экономику и рост сложности.
- **Контентные таблицы** — данные про сущности (POI, враги, лут, апгрейды и т.п.). Контент может ссылаться на параметры TUNING, но не должен хардкодить числа в коде.
- **Системы** — кодовые подсистемы (езда, рейд, угрозы, экономика), которые читают TUNING и применяют формулы.
- **RunState** — текущее состояние рана/профиля (топливо, прочность, уровень угрозы и т.п.). TUNING не хранит состояние.

## 3. Принципы и правила
### 3.1 Один источник правды
- Все балансные числа живут в одном месте: «таблица TUNING».
- В коде допускаются числа только **технического характера** (например, размер экрана), но не баланс.

### 3.2 Стабильные ключи
- Имена ключей TUNING — контракт. Меняются редко и осознанно.
- Изменение значения — нормальная ежедневная практика.

### 3.3 Явные единицы измерения
Для каждого параметра фиксируем единицы:
- секунды, урон/сек, скорость (ед/сек), проценты (0..1), цены (скрап), веса (относительные), множители.

### 3.4 TUNING содержит «ручки», а не формулы
- TUNING хранит только значения и простые группы значений.
- Формулы и производные вычисления живут в системах.

### 3.5 Разделение ответственности
- **TUNING** — что можно крутить.
- **Системы** — как применять (формулы).
- **Контент** — что встречается в игре.
- **RunState** — текущее состояние.

### 3.6 Детеминизм и тестируемость
- Любая значимая настройка, влияющая на ощущения/сложность, должна быть в TUNING.
- При фиксированном сидe рана и фиксированном TUNING поведение должно быть воспроизводимым.

## 4. Структура TUNING
TUNING делится на домены. Домены — это «папки» параметров.

Рекомендуемые домены:
1) **CORE** — общие параметры симуляции и ограничения (например, ограничение шага времени).
2) **DRIVE** — всё, что относится к езде и дорожному сегменту.
3) **CAR** — базовые характеристики машины и деградация.
4) **POI** — параметры рейда: таймеры, окна эвакуации, давление.
5) **COMBAT/THREATS** — общие множители для угроз и взаимодействий (без привязки к конкретному врагу).
6) **LOOT** — глобальные множители лута, веса редкостей.
7) **ECONOMY** — награды/цены/коэффициенты покупки-продажи.
8) **DIFFICULTY** — рост уровня угрозы и кривые скейла.
9) **UI/FEEL** — читаемость и «ощущение» (например, пороги предупреждений).
10) **DEBUG** — переключатели для тестов (не в релизном билде или скрыты).

## 5. Типы параметров
### 5.1 Абсолютные значения
Примеры: максимальная скорость, базовый таймер рейда, базовая прочность машины.

### 5.2 Множители
Примеры: множитель урона по машине, множитель наград на уровне угрозы.

### 5.3 Веса и вероятности
- Вероятности задаются как число от 0 до 1.
- Веса задаются как относительные величины (например, веса редкостей).

### 5.4 Пороговые значения
Примеры: порог перегрева, порог «мало топлива», порог начала ухудшения.

## 6. Как системы используют TUNING
Каждая система:
1) читает нужные параметры из TUNING;
2) применяет их к RunState или к симуляции;
3) не хранит «баланс» внутри себя.

### 6.1 Езда (DRIVE)
Должно настраиваться:
- ускорение/торможение;
- максимальная скорость;
- «управляемость» (поворот/снос/сцепление);
- расход топлива/энергии (в простое и в движении);
- нагрев и охлаждение;
- урон от столкновений (база и зависимость от скорости);
- «кадры неуязвимости» после удара (если используются);
- темп сегмента (минимальная/максимальная длительность пути или целевые значения).

**Ожидаемое поведение:** изменение чисел в TUNING должно менять ощущение управления и темп без изменения логики.

### 6.2 Машина (CAR)
Должно настраиваться:
- базовые максимумы (HP/топливо/батарея/тепло);
- эффективность ремонта (сколько восстанавливает один набор/ресурс);
- скорость ремонта (если есть анимация/каналинг);
- износ деталей за сегмент/за действие;
- штрафы при критических состояниях.

### 6.3 Рейд/POI (POI)
Должно настраиваться:
- базовое время рейда;
- бонусы к времени от апгрейдов/перков;
- окно эвакуации;
- скорость нарастания давления (например, тревога/шум) и спад;
- пороги переходов состояний (например, «опасная стадия»).

### 6.4 Угрозы (COMBAT/THREATS)
Должно настраиваться:
- общие множители урона от разных типов источников;
- длительности «глушения/отключения» для классов угроз (например, дроны/турели);
- параметры давления погони (частота, ускорение, интенсивность).

Важно: конкретные враги/аномалии описываются в контентных таблицах, а TUNING задаёт системные коэффициенты.

### 6.5 Лут (LOOT)
Должно настраиваться:
- глобальный множитель выпадения;
- веса редкостей;
- правила стэка/лимиты по умолчанию;
- глобальные поправки на уровень угрозы.

### 6.6 Экономика гаража (ECONOMY)
Должно настраиваться:
- базовые награды за сегмент/POI;
- коэффициенты покупки/продажи;
- стоимость ремонта (если ремонт требует скрапа) и формула стоимости (в виде коэффициентов).

### 6.7 Сложность (DIFFICULTY)
Должно настраиваться:
- стартовый уровень угрозы;
- как растёт угроза по сегментам/POI/ошибкам;
- кривые скейла (множители HP/урона/частоты угроз);
- «компенсации» и «наказания» (например, усиление угроз после провала).

## 7. Связь TUNING и контента
Контентные сущности (POI, враги, лут, апгрейды):
- могут иметь собственные параметры в таблицах;
- могут ссылаться на параметры TUNING как на «глобальные правила»;
- не должны дублировать одно и то же число в разных местах.

Пример правила:
- У конкретного дрона есть «базовое здоровье» в контенте,
- А множитель здоровья от уровня угрозы — в DIFFICULTY.

## 8. Версионирование и совместимость
### 8.1 Версия TUNING
- У TUNING должен быть `tuning_version`.
- При сохранении игры фиксируется версия TUNING, с которой был сделан сейв (или ран).

### 8.2 Политика изменений
- Изменение значения не требует миграции.
- Переименование/удаление ключа требует:
  - обновления документа;
  - миграции (если ключ влиял на сохранённые данные или контент);
  - отметки в changelog.

## 9. Оверрайды для тестов
В препроде допускаются «тестовые профили» настроек:
- **DEV-оверрайд**: набор параметров, позволяющий быстро проверять петлю (например, меньше таймеры, больше лут).
- **Профили сложности**: наборы, меняющие DIFFICULTY/ECONOMY.

Правило: оверрайд не должен ломать структуру ключей, только значения.

## 10. Минимальная валидация
Перед запуском игры/рана система должна проверять:
- обязательные домены существуют;
- ключевые значения — числа;
- вероятности находятся в 0..1;
- пороги и максимумы не отрицательные;
- очевидные отношения соблюдены (например, MAX_SPEED > 0, порог перегрева ≤ HEAT_MAX).

## 11. Процесс работы с балансом
### 11.1 Итерационный цикл
1) определяем цель изменения (например, «езда слишком вязкая»);
2) меняем только параметры в TUNING;
3) прогоняем короткий тестовый сценарий;
4) фиксируем результат (заметка + новое значение).

### 11.2 Обязательные тест-сценарии для M1
- полный цикл: гараж → карта → езда → POI → эвакуация → результат → гараж;
- стресс: частые столкновения, почти пустое топливо, перегрев;
- проверка роста угрозы на 3–5 сегментах.

## 12. «Границы» M1 (вертикальный срез)
В M1 достаточно, чтобы TUNING покрывал:
- управление и темп DRIVE;
- базовые пулы CAR;
- базовые таймеры POI;
- простую модель наград/цен;
- базовый рост угрозы.

Полная детализация по врагам/аномалиям/разным POI может быть расширена в M2–M3.

## 13. Контрольный список готовности (Definition of Done)
TUNING считается готовым для M1, если:
- нет балансных чисел, спрятанных в системах (кроме технических);
- любые изменения ощущений езды/таймеров/наград делаются без правок логики;
- есть домены DRIVE/CAR/POI/ECONOMY/DIFFICULTY;
- есть минимальная валидация;
- зафиксированы единицы измерения для ключевых параметров;
- есть политика версий.

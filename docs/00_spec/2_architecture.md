# Wyrdway — Architecture v0 (Scenes & Flow)

Цель этого документа: зафиксировать **набор сцен**, **переходы** и **правила владения кадром**, чтобы дальше код не превратился в “глобальные флаги и хаос”.

---

## Tech stack / Language (v0)

- **Runtime v0:** TIC-80
- **Language v0:** Python (TIC-80 Python mode)
- **Переоценка решения:** если упрёмся в производительность, лимиты TIC-80 или неудобства Python-режима — мигрируем на **Lua (внутри TIC-80)** либо на **Pyxel (вне TIC-80)**.
- **Принцип:** ядро игры (контент-таблицы, RunState, контракты сцен) держим максимально data-driven и модульным, чтобы миграция языка/рантайма была управляемой.
- **Не цель v0:** заранее “абстрагировать всё под переносимость” ценой сложности — сначала собираем рабочий вертикальный срез.


---

## 1) Основной цикл (M1)

Вертикальный срез M1 строится вокруг петли:

**TITLE → GARAGE → REGION_MAP → DRIVE(travel) → POI_V0 → DRIVE(extract) → RESULT → GARAGE**

Ключевая идея: **“побег на машине” после POI обязателен**, но реализуется как **тот же DRIVE**, просто в другом режиме.

---

## 2) Сцены (M1)

### TITLE
- Старт игры.
- Переход: `Start` → `GARAGE`.

### GARAGE
- Мета-хаб: подготовка к забегу.
- В MVP: минимум кнопок/меню (Start Run, возможно “Upgrades/Inventory” заглушками).
- Переход: `Start Run` → `REGION_MAP`.

### REGION_MAP
- Выбор следующего узла (node) и генерация параметров забега.
- Переход: `Choose Node` → `DRIVE(travel)` с параметрами узла.

### DRIVE
Одна сцена, два режима:

- `mode = "travel"`  
  Дорога к узлу (POI/событие). Завершается “прибыл”.

- `mode = "extract"`  
  Короткий побег после POI. Завершается “успешно выехал” или “провал”.

Переходы:
- `DRIVE(travel)` → `POI_V0` (если выбранный узел — POI)
- `DRIVE(travel)` → `RESULT` (если узел не POI и сразу завершаем сегмент)
- `DRIVE(extract)` → `RESULT`

### POI_V0
Упрощённая вылазка (без пешей карты):
- Таймер
- 1–3 действия “полутать/взять ресурс/уйти”
- На выходе формирует “дельту” (что нашли/потратили) и запускает побег

Переход:
- `Leave / Timer End` → `DRIVE(extract)`

### RESULT
Итоги сегмента:
- Показать: что нашли, что потратили, урон/состояние машины, успех/провал
- Применить дельты к RunState (или подтвердить уже применённые изменения)
- Переход: `Continue` → `GARAGE`

---

## 3) Правило владения кадром: Replace SceneManager

В каждый момент времени **активна ровно одна сцена**.
Только активная сцена:
- читает ввод
- обновляет таймеры/системы
- рисует кадр

SceneManager работает в режиме **Replace** (без стека).
Оверлеи (пауза/инвентарь поверх DRIVE) — позже.

---

## 4) Контракт сцены (минимум)

Каждая сцена должна поддерживать методы:
- `enter(params)` — инициализация сцены
- `update(dt)` — логика кадра
- `draw()` — отрисовка
- `exit()` — очистка/снятие подписок

---

## 5) Переходы и данные (params)

Переходы делаются через:
- `SceneManager:go(scene_id, params)`

`params` — небольшой пакет контекста, чтобы сцена знала:
- какой режим/узел/сегмент
- какая “миссия” сейчас выполняется

Пример:
- `go("DRIVE", { mode = "travel", node_id = selected_node_id })`

---

## 6) DRIVE: режимы travel / extract

### Общие принципы
- Это **одна сцена**, чтобы не плодить почти одинаковый код.
- Разница только в параметрах и правилах завершения.

### DRIVE(travel)
- цель: “доехать до узла”
- завершение: достигнут “arrival condition”
- если узел POI: перейти в `POI_V0`

### DRIVE(extract)
- цель: “выжить N секунд / доехать до выхода”
- длительность: короткая (например 10–20 секунд; позже вынесем в TUNING)
- угрозы: ограниченный набор (чтобы M1 не расползался)
- завершение: success → RESULT, fail → RESULT

---

## 7) POI_V0: как мы “не телепортируемся”

POI_V0 **не отправляет напрямую в гараж**.

Логика:
- POI_V0 заканчивается решением “уйти/время вышло”
- дальше идёт **DRIVE(extract)** как побег
- затем **RESULT**, который уже возвращает в гараж

Таким образом, “убежать на машине” — часть петли, а не подразумеваемая магия.

---

## 8) Правила на будущее (не делать сейчас)

- **Scene stack (push/pop)** для паузы/оверлеев — позже.
- “POI как подрежим внутри DRIVE” — позже (когда появится полноценный пеший POI).

---

## 9) Definition of Done для M1 по архитектуре

Считаем архитектуру сцен готовой, когда:
- можно пройти петлю TITLE → GARAGE → REGION_MAP → DRIVE(travel) → POI_V0 → DRIVE(extract) → RESULT → GARAGE
- ни одна сцена не обновляется “в фоне”
- переходы не ломают состояние (нет “потерянных данных” при смене сцен)
